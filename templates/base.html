<!-- templates/base.html -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="专业的芯片产品与技术解决方案">
    <meta name="keywords" content="芯片,半导体,电子元器件,集成电路">
    <title>{% block title %}芯片网站{% endblock %}</title>

    <!-- 预加载关键资源 -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com/ajax/libs">

    <!-- 引入CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- 引入Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 引入Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    {% block extra_css %}{% endblock %}
</head>
<body>
<!-- 跳过导航链接（无障碍功能） -->
<a href="#main-content" class="skip-to-main visually-hidden">跳到主要内容</a>

<!-- 导航栏核心结构 -->
<nav class="navbar" aria-label="主导航">
    <div class="nav-container">
        <!-- 移动端汉堡菜单按钮 -->
        <button class="menu-toggle" aria-label="菜单" aria-expanded="false" aria-controls="main-navigation">
                <span class="menu-toggle-icon" aria-hidden="true">
                    <i class="fas fa-bars"></i>
                </span>
            <span class="visually-hidden">菜单</span>
        </button>

        <!-- 左侧导航：HOME + 新增的ABOUT US/LINE CARD等 -->
        <ul class="nav-main">
            <li class="nav-item"><a href="#" class="nav-link active">HOME</a></li>
            <li class="nav-item has-dropdown">
                <a href="#" class="nav-link">ABOUT US <span class="dropdown-arrow">▼</span></a>
                <ul class="dropdown">
                    <li class="dropdown-item"><a href="#" class="dropdown-link">公司简介</a></li>
                    <li class="dropdown-item"><a href="#" class="dropdown-link">团队成员</a></li>
                </ul>
            </li>
            <li class="nav-item has-dropdown">
                <a href="#" class="nav-link">QUALITY CONTROL <span class="dropdown-arrow">▼</span></a>
                <ul class="dropdown">
                    <li class="dropdown-item"><a href="#" class="dropdown-link">质量体系</a></li>
                    <li class="dropdown-item"><a href="#" class="dropdown-link">检测流程</a></li>
                </ul>
            </li>
            <li class="nav-item has-dropdown">
                <a href="#" class="nav-link">LINE CARD <span class="dropdown-arrow">▼</span></a>
                <ul class="dropdown">
                    <li class="dropdown-item"><a href="#" class="dropdown-link">产品线1</a></li>
                    <li class="dropdown-item"><a href="#" class="dropdown-link">产品线2</a></li>
                </ul>
            </li>
            <li class="nav-item"><a href="#" class="nav-link">CONTACT US</a></li>
        </ul>

        <!-- 右侧导航：语言切换 + 管理员登录（靠右） -->
        <ul class="nav-right" role="menubar" aria-label="辅助导航">
            <!-- 语言切换 -->
            <li class="nav-item has-dropdown language-container" role="none">
                <a href="#"
                   class="nav-link"
                   role="menuitem"
                   aria-expanded="false"
                   aria-haspopup="true"
                   aria-controls="language-dropdown">
                    {{ _('语言') }}
                    <span class="dropdown-arrow" aria-hidden="true">▼</span>
                </a>
                <ul id="language-dropdown" class="dropdown language-dropdown" role="menu" aria-label="语言选择">
                    <li class="dropdown-item" role="none">
                        <a href="{{ url_for('set_language', lang='en') }}" class="dropdown-link" role="menuitem"
                           lang="en">English</a>
                    </li>
                    <li class="dropdown-item" role="none">
                        <a href="{{ url_for('set_language', lang='fr') }}" class="dropdown-link" role="menuitem"
                           lang="fr">Français</a>
                    </li>
                    <li class="dropdown-item" role="none">
                        <a href="{{ url_for('set_language', lang='ja') }}" class="dropdown-link" role="menuitem"
                           lang="ja">日本語</a>
                    </li>
                    <li class="dropdown-item" role="none">
                        <a href="{{ url_for('set_language', lang='zh') }}" class="dropdown-link" role="menuitem"
                           lang="zh">中文</a>
                    </li>
                </ul>
            </li>

            <!-- 管理员登录 -->
            <li class="nav-item admin-item" role="none">
                <a href="{{ url_for('admin_login') }}"
                   class="nav-link {% if request.endpoint == 'admin_login' %}active{% endif %}"
                   role="menuitem"
                   aria-current="{% if request.endpoint == 'admin_login' %}page{% else %}false{% endif %}">
                    管理员
                </a>
            </li>
        </ul>
    </div>
</nav>

<!-- 页面内容区域（子页面继承时填充） -->
<main id="main-content" class="container" tabindex="-1">
    {% block content %}{% endblock %}
</main>

<!-- 页脚 -->
<footer role="contentinfo">
    <div class="container text-center">
        <p>&copy; {% block footer %}2025 芯片网站 版权所有{% endblock %}</p>
        <p class="footer-links">
            <a href="{{ url_for('index') }}">首页</a> |
            <a href="{{ url_for('about') }}">关于我们</a> |
            <a href="{{ url_for('contact_page') }}">联系我们</a> |
            <a href="{{ url_for('admin_login') }}">管理员登录</a>
        </p>
    </div>
</footer>

<!-- 异步加载外部脚本 -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" defer></script>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous" defer></script>

<!-- 导航栏交互脚本 -->
<script>
    (function() {
        'use strict';

        // 缓存DOM元素
        const domCache = {
            menuToggle: null,
            navLeft: null,
            navRight: null,
            dropdownToggles: null
        };

        // 配置
        const config = {
            mobileBreakpoint: 768,
            transitionDuration: 300,
            dropdownDelay: 150
        };

        // 初始化
        function init() {
            cacheDomElements();
            setupEventListeners();
            initAccessibility();
            handleInitialState();
        }

        // 缓存DOM元素
        function cacheDomElements() {
            domCache.menuToggle = document.querySelector('.menu-toggle');
            domCache.navLeft = document.querySelector('.nav-left');
            domCache.navRight = document.querySelector('.nav-right');
            domCache.dropdownToggles = document.querySelectorAll('.has-dropdown > .nav-link');
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 移动端菜单切换
            if (domCache.menuToggle) {
                domCache.menuToggle.addEventListener('click', handleMenuToggle);
            }

            // 移动端下拉菜单点击切换 - 使用事件委托
            document.addEventListener('click', handleDropdownClick);

            // 点击页面其他地方关闭下拉菜单
            document.addEventListener('click', handleDocumentClick);

            // 窗口大小改变时重置菜单状态
            window.addEventListener('resize', debounce(handleResize, 250));

            // 键盘导航支持
            document.addEventListener('keydown', handleKeyboardNavigation);
        }

        // 初始化无障碍功能
        function initAccessibility() {
            // 为所有链接添加focus样式支持
            document.addEventListener('focusin', function(e) {
                if (e.target.matches('a, button, input, [tabindex]')) {
                    e.target.classList.add('focus-visible');
                }
            });

            document.addEventListener('focusout', function(e) {
                if (e.target.matches('a, button, input, [tabindex]')) {
                    e.target.classList.remove('focus-visible');
                }
            });
        }

        // 处理初始状态
        function handleInitialState() {
            // 如果是移动端，确保菜单是隐藏的
            if (window.innerWidth <= config.mobileBreakpoint) {
                hideMobileMenus();
            }
        }

        // 移动端菜单切换
        function handleMenuToggle() {
            const isExpanded = this.getAttribute('aria-expanded') === 'true';
            const newExpandedState = !isExpanded;

            this.setAttribute('aria-expanded', newExpandedState);

            if (newExpandedState) {
                showMobileMenus();
            } else {
                hideMobileMenus();
            }
        }

        // 显示移动端菜单
        function showMobileMenus() {
            domCache.navLeft.classList.add('show');
            domCache.navRight.classList.add('show');
            domCache.menuToggle.setAttribute('aria-expanded', 'true');
        }

        // 隐藏移动端菜单
        function hideMobileMenus() {
            domCache.navLeft.classList.remove('show');
            domCache.navRight.classList.remove('show');
            document.querySelectorAll('.dropdown.show').forEach(dropdown => {
                dropdown.classList.remove('show');
                const trigger = dropdown.previousElementSibling;
                if (trigger) {
                    trigger.setAttribute('aria-expanded', 'false');
                }
            });

            if (domCache.menuToggle) {
                domCache.menuToggle.setAttribute('aria-expanded', 'false');
            }
        }

        // 处理下拉菜单点击
        function handleDropdownClick(e) {
            // 仅在移动端生效
            if (window.innerWidth > config.mobileBreakpoint) return;

            const toggle = e.target.closest('.has-dropdown > .nav-link');
            if (!toggle) return;

            e.preventDefault();
            e.stopPropagation();

            const dropdown = toggle.nextElementSibling;
            const isVisible = dropdown.classList.contains('show');

            // 关闭其他打开的下拉菜单
            document.querySelectorAll('.dropdown.show').forEach(d => {
                if (d !== dropdown) {
                    d.classList.remove('show');
                    const otherToggle = d.previousElementSibling;
                    if (otherToggle) {
                        otherToggle.setAttribute('aria-expanded', 'false');
                    }
                }
            });

            // 切换当前下拉菜单
            const newExpandedState = !isVisible;
            dropdown.classList.toggle('show', newExpandedState);
            toggle.setAttribute('aria-expanded', newExpandedState.toString());
        }

        // 处理文档点击（关闭下拉菜单）
        function handleDocumentClick(e) {
            // 仅在移动端生效
            if (window.innerWidth > config.mobileBreakpoint) return;

            if (!e.target.closest('.has-dropdown')) {
                hideDropdowns();
            }
        }

        // 隐藏所有下拉菜单
        function hideDropdowns() {
            document.querySelectorAll('.dropdown.show').forEach(dropdown => {
                dropdown.classList.remove('show');
                const trigger = dropdown.previousElementSibling;
                if (trigger) {
                    trigger.setAttribute('aria-expanded', 'false');
                }
            });
        }

        // 处理窗口大小改变
        function handleResize() {
            if (window.innerWidth > config.mobileBreakpoint) {
                // 桌面端：隐藏移动菜单
                hideMobileMenus();
            } else {
                // 移动端：确保菜单是隐藏的
                hideMobileMenus();
            }
        }

        // 键盘导航支持
        function handleKeyboardNavigation(e) {
            // ESC键关闭菜单
            if (e.key === 'Escape') {
                if (window.innerWidth <= config.mobileBreakpoint) {
                    hideMobileMenus();
                } else {
                    hideDropdowns();
                }
            }

            // Tab键在移动端菜单中的处理
            if (e.key === 'Tab' && window.innerWidth <= config.mobileBreakpoint) {
                const menuVisible = domCache.navLeft.classList.contains('show');
                if (!menuVisible) return;

                const focusableElements = document.querySelectorAll('.nav-left a, .nav-right a, .menu-toggle');
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                if (e.shiftKey && document.activeElement === firstElement) {
                    e.preventDefault();
                    lastElement.focus();
                } else if (!e.shiftKey && document.activeElement === lastElement) {
                    e.preventDefault();
                    firstElement.focus();
                }
            }
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 页面加载完成后初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    })();
</script>

{% block extra_js %}{% endblock %}
</body>
</html>